name: PR Test (XPU)

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: pr-test-xpu-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run-ci')
    permissions: write-all
    runs-on: sglang-bmg
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build \
            --build-arg SG_LANG_KERNEL_BRANCH=${{ github.head_ref }} \
            --build-arg SG_LANG_KERNEL_REPO=${{ github.event.pull_request.head.repo.clone_url }} \
            --no-cache --progress=plain -f Dockerfile.xpu_kernel -t xpu_sglang:kernel .

      - name: Run container
        run: |
          docker run -dt \
            --device /dev/dri/ \
            --name ci_sglang_xpu \
            -e HF_TOKEN=$(cat ~/huggingface_token.txt) \
            xpu_sglang:kernel

      - name: Install Dependency
        timeout-minutes: 20
        run: |
          docker exec ci_sglang_xpu /miniforge3/envs/py3.10/bin/python3 -m pip install --upgrade pip
          docker exec ci_sglang_xpu /miniforge3/envs/py3.10/bin/python3 -m pip install pytest expecttest ray huggingface_hub
          docker exec ci_sglang_xpu /bin/bash -c '/miniforge3/envs/py3.10/bin/huggingface-cli login --token ${HF_TOKEN} '
          docker exec ci_sglang_xpu /bin/bash -c "ln -sf /miniforge3/envs/py3.10/bin/python3 /usr/bin/python3"

      - name: Run Sglang Kernel Cases
        timeout-minutes: 20
        run: |
          docker exec -w /root/sglang ci_sglang_xpu \
            /bin/bash -c "cd /root/sglang/sgl-kernel-xpu/tests &&  python3 run_suite.py --suite per-commit "

      - name: Run Sglang Kernel Benchmarks
        timeout-minutes: 20
        run: |
          docker exec -w /root/sglang ci_sglang_xpu \
            /bin/bash -c "\
              /miniforge3/envs/py3.10/bin/python3 -m pip install tabulate && \
              cd /root/sglang/sgl-kernel-xpu/benchmark && \
              python3 bench_flash_attn.py 2>&1 | tee flash.log && \
              python3 bench_moe_topk_softmax.py 2>&1 | tee moe.log && \
              python3 bench_fused_moe.py 2>&1 | tee fused_moe.log && \
              python3 bench_moe_sum_reduce.py 2>&1 | tee moe_sum_reduce.log \
              python3 bench_moe_fused_gate.py 2>&1 | tee moe_fused_gate.py.log \
              python3 bench_merge_states_v2.py 2>&1 | tee merge_states.py.log \
            "

      - name: Copy logs from container
        timeout-minutes: 20
        run: |
          docker cp ci_sglang_xpu:/root/sglang/sgl-kernel-xpu/benchmark/fused_moe.log ./fused_moe.log
          python3 benchmark/update_baseline_from_log.py

      - name: Install GitHub CLI
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'perf')
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Auto PR for baseline.json update
        if: >
          success() &&
          contains(join(github.event.pull_request.labels.*.name, ','), 'perf') &&
          hashFiles('ci_has_lower.txt') != ''
        run: |
          SRC_PR=${{ github.event.pull_request.number }}
          BRANCH="ci/update-baseline-pr-${SRC_PR}"
          BASE="main"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ "$(cat ci_has_lower.txt)" = "0" ]; then
            echo "No LOWER entries, skipping PR."
            exit 0
          fi

          TMP_BASELINE=$(mktemp)
          cp benchmark/baseline.json "$TMP_BASELINE"

          TMP_BODY=$(mktemp)
          cp ci_pr_body.md "$TMP_BODY"

          git reset --hard
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
            git checkout "$BRANCH"
          else
            git checkout -B "$BRANCH" "origin/$BASE"
          fi

          cp "$TMP_BASELINE" benchmark/baseline.json
          cp "$TMP_BODY" ci_pr_body.md
          git add benchmark/baseline.json
          if command -v pre-commit >/dev/null 2>&1; then
              pre-commit run --files benchmark/baseline.json || true
              git add benchmark/baseline.json
          fi
          git commit -m "CI intermediate baseline update" || echo "No changes to commit"
          echo "Detected changes in baseline.json: $(git diff --cached --stat)"

          echo "${{ secrets.PAT }}" | gh auth login --with-token || { echo "gh auth login failed"; exit 1; }
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/sgl-project/sgl-kernel-xpu.git
          git push -f https://${{ secrets.PAT }}@github.com/sgl-project/sgl-kernel-xpu.git "$BRANCH"

          PR_NUMBER=$(gh pr list \
            --repo sgl-project/sgl-kernel-xpu \
            --head "$BRANCH" \
            --base "$BASE" \
            --json number \
            --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            PR_URL=$(gh pr create \
              --repo sgl-project/sgl-kernel-xpu \
              --title "CI: Update baseline.json (from PR #${SRC_PR}) " \
              --body-file ci_pr_body.md \
              --base "$BASE" \
              --head "$BRANCH"
            )

            echo "PR created at $PR_URL"
          else
            echo "Baseline PR #$PR_NUMBER already exists for source PR #${SRC_PR}, updated with new commit."
            gh pr comment "$PR_NUMBER" \
              --repo sgl-project/sgl-kernel-xpu \
              --body-file ci_pr_body.md
          fi

      - name: Run E2E Bfloat16 tests
        timeout-minutes: 20
        run: |
          echo "[PlaceHolder for E2E Test...]"

      - name: Run E2E Qunatization tests
        timeout-minutes: 20
        run: |
          echo "[PlaceHolder for E2E Test...]"

      - name: Cleanup container
        if: always()
        run: |
          docker rm -f ci_sglang_xpu || true
